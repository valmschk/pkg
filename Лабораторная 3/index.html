<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Processing Lab - Matrix Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff41;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        .matrix-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(0, 255, 65, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(138, 43, 226, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(0, 191, 255, 0.1) 0%, transparent 50%);
            animation: matrixPulse 8s ease-in-out infinite alternate;
            z-index: -2;
        }

        @keyframes matrixPulse {
            0% { opacity: 0.3; }
            100% { opacity: 0.7; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .esoteric-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
        }

        .glitch-text {
            font-size: 2.5em;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 4px;
            position: relative;
            color: #00ff41;
            text-shadow: 
                0 0 10px #00ff41,
                0 0 20px #00ff41,
                0 0 40px #00ff41;
        }

        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .cyber-text {
            font-size: 1.2em;
            color: #8a2be2;
            text-shadow: 0 0 10px #8a2be2;
        }

        .app-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid #00ff41;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 
                0 0 20px rgba(0, 255, 65, 0.3),
                inset 0 0 20px rgba(0, 255, 65, 0.1);
            position: relative;
            overflow: hidden;
        }

        .control-panel {
            background: rgba(20, 20, 20, 0.9);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #8a2be2;
            box-shadow: 
                inset 0 0 20px rgba(138, 43, 226, 0.2),
                0 0 20px rgba(138, 43, 226, 0.1);
        }

        .panel-title {
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #00bfff;
            text-shadow: 0 0 10px #00bfff;
        }

        .control-group {
            margin-bottom: 25px;
            position: relative;
        }

        .control-group h3 {
            margin-bottom: 15px;
            color: #00ff41;
            border-bottom: 1px solid #00ff41;
            padding-bottom: 5px;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-neon {
            background: rgba(0, 255, 65, 0.1);
            color: #00ff41;
            border: 1px solid #00ff41;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }

        .btn-neon:hover {
            background: rgba(0, 255, 65, 0.2);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
        }

        .btn-mystic {
            background: rgba(138, 43, 226, 0.1);
            color: #8a2be2;
            border: 1px solid #8a2be2;
            box-shadow: 0 0 10px rgba(138, 43, 226, 0.3);
        }

        .btn-mystic:hover {
            background: rgba(138, 43, 226, 0.2);
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.5);
        }

        .btn-test {
            background: rgba(0, 191, 255, 0.1);
            color: #00bfff;
            border: 1px solid #00bfff;
            box-shadow: 0 0 10px rgba(0, 191, 255, 0.3);
            font-size: 11px;
        }

        .btn-test:hover {
            background: rgba(0, 191, 255, 0.2);
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.5);
        }

        .method-option {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            position: relative;
        }

        .method-option:hover {
            background: rgba(0, 255, 65, 0.1);
            border-color: #00ff41;
        }

        .method-option input {
            display: none;
        }

        .checkmark {
            width: 18px;
            height: 18px;
            border: 2px solid #00ff41;
            border-radius: 3px;
            margin-right: 10px;
            position: relative;
            transition: all 0.3s ease;
        }

        .method-option input:checked + .checkmark {
            background: #00ff41;
            box-shadow: 0 0 10px #00ff41;
        }

        .method-option input:checked + .checkmark::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-weight: bold;
            font-size: 12px;
        }

        .slider-container {
            margin: 15px 0;
        }

        .slider-container label {
            display: block;
            margin-bottom: 8px;
            font-size: 11px;
            color: #00bfff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .slider-neon {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, #00ff41, #8a2be2);
            outline: none;
            -webkit-appearance: none;
        }

        .slider-neon::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00ff41;
            cursor: pointer;
            box-shadow: 0 0 10px #00ff41;
            border: 2px solid #000;
        }

        .slider-neon::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00ff41;
            cursor: pointer;
            box-shadow: 0 0 10px #00ff41;
            border: 2px solid #000;
        }

        .display-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 600px;
        }

        .portal-frame {
            background: rgba(20, 20, 20, 0.9);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #00bfff;
            box-shadow: 
                inset 0 0 20px rgba(0, 191, 255, 0.2),
                0 0 20px rgba(0, 191, 255, 0.1);
            display: flex;
            flex-direction: column;
        }

        .portal-title {
            text-align: center;
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #00bfff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .portal-view {
            width: 100%;
            height: 100%;
            background: #000;
            border-radius: 5px;
            border: 1px solid #00ff41;
            display: block;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding: 10px 20px;
            background: rgba(20, 20, 20, 0.8);
            border-radius: 5px;
            border: 1px solid #8a2be2;
        }

        .status-item {
            display: flex;
            align-items: center;
            font-size: 11px;
            color: #00ff41;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background: #00ff41;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); box-shadow: 0 0 10px #00ff41; }
        }

        .comparison-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(20, 20, 20, 0.9);
            border-radius: 8px;
            border: 1px solid #ffa500;
            box-shadow: 0 0 10px rgba(255, 165, 0, 0.3);
        }

        .comparison-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-comparison {
            background: rgba(255, 165, 0, 0.15);
            color: #ffa500;
            border: 1px solid #ffa500;
            font-size: 10px;
            padding: 8px;
            transition: all 0.3s ease;
        }

        .btn-comparison:hover {
            background: rgba(255, 165, 0, 0.25);
            box-shadow: 0 0 15px rgba(255, 165, 0, 0.5);
            transform: translateY(-2px);
        }

        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
            }
            
            .display-area {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .portal-frame {
                height: 400px;
            }
            
            .glitch-text {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="matrix-bg"></div>
    
    <div class="container">
        <div class="esoteric-header">
            <div class="glitch-text">IMAGE PROCESSING LAB</div>
        </div>
        
        <div class="subtitle">
            <div class="cyber-text">–ü–æ—Ä–æ–≥–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –ù–ß —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è</div>
            <div class="scanline"></div>
        </div>

        <div class="app-container">
            <div class="control-panel">
                <div class="panel-title">
                    <span class="rune">‚ö°</span> –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø <span class="rune">‚ö°</span>
                </div>

                <div class="control-group">
                    <h3>–ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•</h3>
                    <input type="file" id="fileInput" accept="image/*" hidden>
                    <button class="btn btn-neon" onclick="document.getElementById('fileInput').click()">
                        [ –ó–ê–ì–†–£–ó–ò–¢–¨ –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï ]
                    </button>
                    <button class="btn btn-mystic" onclick="app.download()">
                        [ –°–û–•–†–ê–ù–ò–¢–¨ –†–ï–ó–£–õ–¨–¢–ê–¢ ]
                    </button>
                </div>

                <div class="control-group">
                    <h3>–¢–ï–°–¢–û–í–´–ï –°–¶–ï–ù–ê–†–ò–ò</h3>
                    <button class="btn btn-test" onclick="app.generateTest('noise')">
                        –®—É–º "–°–æ–ª—å/–ü–µ—Ä–µ—Ü"
                    </button>
                    <button class="btn btn-test" onclick="app.generateTest('uneven')">
                        –ù–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã–π —Å–≤–µ—Ç
                    </button>
                    <button class="btn btn-test" onclick="app.generateTest('low_contrast')">
                        –ù–∏–∑–∫–∏–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç
                    </button>
                </div>

                <div class="control-group">
                    <h3>–ê–õ–ì–û–†–ò–¢–ú–´ –û–ë–†–ê–ë–û–¢–ö–ò</h3>
                    <label class="method-option">
                        <input type="radio" name="algo" value="original" checked>
                        <span class="checkmark"></span>
                        –û—Ä–∏–≥–∏–Ω–∞–ª
                    </label>
                    <label class="method-option">
                        <input type="radio" name="algo" value="gaussian">
                        <span class="checkmark"></span>
                        –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ (–ì–∞—É—Å—Å)
                    </label>
                    <label class="method-option">
                        <input type="radio" name="algo" value="median">
                        <span class="checkmark"></span>
                        –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ (–ú–µ–¥–∏–∞–Ω–∞)
                    </label>
                    <label class="method-option">
                        <input type="radio" name="algo" value="binary">
                        <span class="checkmark"></span>
                        –ì–ª–æ–±. –ü–æ—Ä–æ–≥ (–†—É—á–Ω–æ–π)
                    </label>
                    <label class="method-option">
                        <input type="radio" name="algo" value="otsu">
                        <span class="checkmark"></span>
                        –ì–ª–æ–±. –ü–æ—Ä–æ–≥ (Otsu)
                    </label>
                    <label class="method-option">
                        <input type="radio" name="algo" value="adaptive">
                        <span class="checkmark"></span>
                        –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π (Mean-C)
                    </label>
                </div>

                <div class="control-group">
                    <h3>–ü–ê–†–ê–ú–ï–¢–†–´ –°–ò–°–¢–ï–ú–´</h3>
                    <div class="slider-container">
                        <label>–†–∞–∑–º–µ—Ä —è–¥—Ä–∞: <span id="val-kernel">3</span></label>
                        <input type="range" class="slider-neon" id="p-kernel" min="3" max="15" step="2" value="3">
                    </div>
                    <div class="slider-container">
                        <label>–ü–æ—Ä–æ–≥: <span id="val-thresh">128</span></label>
                        <input type="range" class="slider-neon" id="p-thresh" min="0" max="255" value="128">
                    </div>
                    <div class="slider-container">
                        <label>–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ C: <span id="val-c">5</span></label>
                        <input type="range" class="slider-neon" id="p-c" min="-20" max="50" value="5">
                    </div>
                    <div class="slider-container">
                        <label>–†–∞–∑–º–µ—Ä –æ–∫–Ω–∞: <span id="val-block">15</span></label>
                        <input type="range" class="slider-neon" id="p-block" min="3" max="51" step="2" value="15">
                    </div>
                </div>

                <div class="comparison-section">
                    <h3>–°–†–ê–í–ù–ï–ù–ò–ï –ú–ï–¢–û–î–û–í</h3>
                    <div class="comparison-buttons">
                        <button class="btn btn-comparison" onclick="app.showComparison('noise')">
                            –®—É–º ‚Üí –ú–µ–¥–∏–∞–Ω–∞
                        </button>
                        <button class="btn btn-comparison" onclick="app.showComparison('uneven')">
                            –¢–µ–Ω—å ‚Üí –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π
                        </button>
                        <button class="btn btn-comparison" onclick="app.showComparison('low_contrast')">
                            –ö–æ–Ω—Ç—Ä–∞—Å—Ç ‚Üí Otsu
                        </button>
                        <button class="btn btn-comparison" onclick="app.showMethodTable()">
                            –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
                        </button>
                    </div>
                </div>
            </div>

            <div class="display-area">
                <div class="portal-frame">
                    <div class="portal-title">
                        <span class="rune-small">‚üÅ</span> –ò–°–•–û–î–ù–û–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï <span class="rune-small">‚üÅ</span>
                    </div>
                    <canvas id="cOrig" class="portal-view"></canvas>
                </div>
                <div class="portal-frame">
                    <div class="portal-title">
                        <span class="rune-small">‚üÅ</span> –†–ï–ó–£–õ–¨–¢–ê–¢ –û–ë–†–ê–ë–û–¢–ö–ò <span class="rune-small">‚üÅ</span>
                    </div>
                    <canvas id="cProc" class="portal-view"></canvas>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="pulse-dot"></div>
                –°–ò–°–¢–ï–ú–ê –ê–ö–¢–ò–í–ù–ê
            </div>
            <div class="status-item" id="status-method">
                –ê–ª–≥–æ—Ä–∏—Ç–º: –û—Ä–∏–≥–∏–Ω–∞–ª
            </div>
            <div class="status-item" id="status-size">
                –†–∞–∑–º–µ—Ä: 500√ó400
            </div>
        </div>
    </div>

    <script>
        class ImageProcessor {
            constructor() {
                this.cOrig = document.getElementById('cOrig');
                this.cProc = document.getElementById('cProc');
                this.ctxOrig = this.cOrig.getContext('2d');
                this.ctxProc = this.cProc.getContext('2d');
                
                this.imgData = null;
                this.originalImage = null;

                this.params = {
                    kernel: 3,
                    threshold: 128,
                    c: 5,
                    blockSize: 15
                };

                this.initListeners();
                this.generateTest('uneven');
            }

            initListeners() {
                document.getElementById('fileInput').addEventListener('change', (e) => {
                    if(e.target.files[0]) this.loadImage(e.target.files[0]);
                });

                ['kernel', 'thresh', 'c', 'block'].forEach(key => {
                    const el = document.getElementById('p-' + key);
                    el.addEventListener('input', (e) => {
                        this.params[key] = parseInt(e.target.value);
                        document.getElementById('val-' + key).innerText = this.params[key];
                        this.process();
                    });
                });

                document.querySelectorAll('input[name="algo"]').forEach(r => {
                    r.addEventListener('change', () => {
                        document.getElementById('status-method').textContent = 
                            `–ê–ª–≥–æ—Ä–∏—Ç–º: ${r.parentElement.textContent.trim()}`;
                        this.process();
                    });
                });
            }

            loadImage(source) {
                const img = new Image();
                img.onload = () => {
                    this.resizeAndDraw(img);
                };
                
                if (source instanceof File) {
                    const reader = new FileReader();
                    reader.onload = (e) => img.src = e.target.result;
                    reader.readAsDataURL(source);
                } else if (typeof source === 'string') {
                    img.src = source;
                }
            }

            resizeAndDraw(img) {
                const maxWidth = 500;
                const maxHeight = 400;
                let { width, height } = img;
                
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                if (height > maxHeight) {
                    width = (width * maxHeight) / height;
                    height = maxHeight;
                }

                this.cOrig.width = this.cProc.width = width;
                this.cOrig.height = this.cProc.height = height;

                this.ctxOrig.clearRect(0, 0, width, height);
                this.ctxOrig.drawImage(img, 0, 0, width, height);
                this.imgData = this.ctxOrig.getImageData(0, 0, width, height);
                
                document.getElementById('status-size').textContent = 
                    `–†–∞–∑–º–µ—Ä: ${width}√ó${height}`;
                
                this.process();
            }

            generateTest(type) {
                const cvs = document.createElement('canvas');
                cvs.width = 500;
                cvs.height = 400;
                const ctx = cvs.getContext('2d');

                if (type === 'noise') {
                    ctx.fillStyle = '#555';
                    ctx.fillRect(0, 0, 500, 400);
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 40px Arial';
                    ctx.fillText("NOISE TEST", 120, 150);
                    ctx.fillText("MEDIAN FILTER", 100, 220);
                    
                    const imgD = ctx.getImageData(0, 0, 500, 400);
                    for(let i = 0; i < imgD.data.length; i += 4) {
                        if(Math.random() < 0.1) {
                            const color = Math.random() > 0.5 ? 255 : 0;
                            imgD.data[i] = imgD.data[i+1] = imgD.data[i+2] = color;
                        }
                    }
                    ctx.putImageData(imgD, 0, 0);
                    
                } else if (type === 'uneven') {
                    const grd = ctx.createLinearGradient(0, 0, 500, 400);
                    grd.addColorStop(0, "#ffffff");
                    grd.addColorStop(1, "#333333");
                    ctx.fillStyle = grd;
                    ctx.fillRect(0, 0, 500, 400);
                    
                    ctx.fillStyle = "#666";
                    ctx.font = "bold 35px Courier New";
                    ctx.fillText("UNEVEN LIGHTING", 50, 120);
                    ctx.fillText("ADAPTIVE THRESHOLD", 40, 200);
                    ctx.fillText("SHADOW TEXT", 120, 280);
                    
                } else {
                    ctx.fillStyle = '#777';
                    ctx.fillRect(0, 0, 500, 400);
                    ctx.fillStyle = '#888';
                    ctx.font = 'bold 45px Arial';
                    ctx.fillText("LOW CONTRAST", 80, 150);
                    ctx.fillText("OTSU METHOD", 100, 230);
                }
                
                this.loadImage(cvs.toDataURL());
            }

            process() {
                if (!this.imgData) return;
                
                const method = document.querySelector('input[name="algo"]:checked').value;
                const src = this.imgData.data;
                const w = this.imgData.width;
                const h = this.imgData.height;
                const output = new ImageData(w, h);
                const dst = output.data;

                const gray = new Uint8ClampedArray(w * h);
                for (let i = 0; i < w * h; i++) {
                    gray[i] = 0.299 * src[i*4] + 0.587 * src[i*4+1] + 0.114 * src[i*4+2];
                }

                switch (method) {
                    case 'original':
                        output.data.set(src);
                        break;

                    case 'gaussian':
                        this.applyGaussian(src, dst, w, h, this.params.kernel);
                        break;

                    case 'median':
                        this.applyMedian(src, dst, w, h, this.params.kernel);
                        break;

                    case 'binary':
                        this.applyGlobalThreshold(gray, dst, w, h, this.params.threshold);
                        break;

                    case 'otsu':
                        const otsuThresh = this.getOtsuThreshold(gray);
                        document.getElementById('val-thresh').innerText = otsuThresh + " (Auto)";
                        this.applyGlobalThreshold(gray, dst, w, h, otsuThresh);
                        break;

                    case 'adaptive':
                        this.applyAdaptiveMean(gray, dst, w, h, this.params.blockSize, this.params.c);
                        break;
                }

                this.ctxProc.putImageData(output, 0, 0);
            }

            applyGaussian(src, dst, w, h, kernelSize) {
                const r = Math.floor(kernelSize / 2);
                for (let y = 0; y < h; y++) {
                    for (let x = 0; x < w; x++) {
                        let rSum = 0, gSum = 0, bSum = 0, count = 0;
                        
                        for (let ky = -r; ky <= r; ky++) {
                            for (let kx = -r; kx <= r; kx++) {
                                const py = Math.min(h-1, Math.max(0, y + ky));
                                const px = Math.min(w-1, Math.max(0, x + kx));
                                const idx = (py * w + px) * 4;
                                rSum += src[idx];
                                gSum += src[idx+1];
                                bSum += src[idx+2];
                                count++;
                            }
                        }
                        const idx = (y * w + x) * 4;
                        dst[idx] = rSum / count;
                        dst[idx+1] = gSum / count;
                        dst[idx+2] = bSum / count;
                        dst[idx+3] = 255;
                    }
                }
            }

            applyMedian(src, dst, w, h, kernelSize) {
                const r = Math.floor(kernelSize / 2);
                for (let y = 0; y < h; y++) {
                    for (let x = 0; x < w; x++) {
                        let reds = [], greens = [], blues = [];
                        
                        for (let ky = -r; ky <= r; ky++) {
                            for (let kx = -r; kx <= r; kx++) {
                                const py = Math.min(h-1, Math.max(0, y + ky));
                                const px = Math.min(w-1, Math.max(0, x + kx));
                                const idx = (py * w + px) * 4;
                                reds.push(src[idx]);
                                greens.push(src[idx+1]);
                                blues.push(src[idx+2]);
                            }
                        }
                        
                        reds.sort((a,b) => a-b);
                        greens.sort((a,b) => a-b);
                        blues.sort((a,b) => a-b);
                        
                        const mid = Math.floor(reds.length / 2);
                        const idx = (y * w + x) * 4;
                        dst[idx] = reds[mid];
                        dst[idx+1] = greens[mid];
                        dst[idx+2] = blues[mid];
                        dst[idx+3] = 255;
                    }
                }
            }

            applyGlobalThreshold(gray, dst, w, h, thresh) {
                for (let i = 0; i < w * h; i++) {
                    const val = gray[i] >= thresh ? 255 : 0;
                    dst[i*4] = dst[i*4+1] = dst[i*4+2] = val;
                    dst[i*4+3] = 255;
                }
            }

            getOtsuThreshold(gray) {
                const hist = new Array(256).fill(0);
                for (let i = 0; i < gray.length; i++) hist[gray[i]]++;

                let total = gray.length;
                let sum = 0;
                for (let i = 0; i < 256; i++) sum += i * hist[i];

                let sumB = 0, wB = 0, wF = 0;
                let varMax = 0, threshold = 0;

                for (let t = 0; t < 256; t++) {
                    wB += hist[t];
                    if (wB === 0) continue;
                    wF = total - wB;
                    if (wF === 0) break;

                    sumB += t * hist[t];
                    let mB = sumB / wB;
                    let mF = (sum - sumB) / wF;

                    let varBetween = wB * wF * (mB - mF) * (mB - mF);
                    if (varBetween > varMax) {
                        varMax = varBetween;
                        threshold = t;
                    }
                }
                return threshold;
            }

            applyAdaptiveMean(gray, dst, w, h, blockSize, C) {
                const r = Math.floor(blockSize / 2);
                
                for (let y = 0; y < h; y++) {
                    for (let x = 0; x < w; x++) {
                        let sum = 0;
                        let count = 0;

                        for (let ky = -r; ky <= r; ky++) {
                            for (let kx = -r; kx <= r; kx++) {
                                const py = Math.min(h-1, Math.max(0, y + ky));
                                const px = Math.min(w-1, Math.max(0, x + kx));
                                sum += gray[py * w + px];
                                count++;
                            }
                        }
                        
                        const mean = sum / count;
                        const pixel = gray[y * w + x];
                        const val = pixel > (mean - C) ? 255 : 0;

                        const idx = (y * w + x) * 4;
                        dst[idx] = dst[idx+1] = dst[idx+2] = val;
                        dst[idx+3] = 255;
                    }
                }
            }

            download() {
                if (!this.cProc) {
                    alert('–ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                    return;
                }
                const link = document.createElement('a');
                link.download = 'processed_image.png';
                link.href = this.cProc.toDataURL();
                link.click();
            }

            showComparison(type) {
                this.generateTest(type);
                setTimeout(() => {
                    let method, message;
                    
                    if (type === 'noise') {
                        method = 'median';
                        message = 'üéØ –ó–ê–®–£–ú–õ–ï–ù–ù–´–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø:\n‚úì –ú–µ–¥–∏–∞–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä > –ì–∞—É—Å—Å–æ–≤ —Ñ–∏–ª—å—Ç—Ä\n‚úì –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —É–±–∏—Ä–∞–µ—Ç –∏–º–ø—É–ª—å—Å–Ω—ã–π —à—É–º\n‚úì –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —á–µ—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã';
                    } else if (type === 'uneven') {
                        method = 'adaptive';
                        message = 'üîÜ –ù–ï–†–ê–í–ù–û–ú–ï–†–ù–û–ï –û–°–í–ï–©–ï–ù–ò–ï:\n‚úì –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã > –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã\n‚úì –õ–æ–∫–∞–ª—å–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞\n‚úì –¢–µ–∫—Å—Ç —á–∏—Ç–∞–µ—Ç—Å—è –¥–∞–∂–µ –≤ —Ç–µ–Ω—è—Ö';
                    } else {
                        method = 'otsu';
                        message = 'üå´Ô∏è –ú–ê–õ–û–ö–û–ù–¢–†–ê–°–¢–ù–´–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø:\n‚úì Otsu > –†—É—á–Ω–æ–π –ø–æ—Ä–æ–≥\n‚úì –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥–±–æ—Ä –ø–æ—Ä–æ–≥–∞\n‚úì –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏';
                    }
                    
                    document.querySelector(`input[value="${method}"]`).checked = true;
                    this.process();
                    
                    setTimeout(() => {
                        alert(message);
                    }, 500);
                }, 100);
            }

            showMethodTable() {
                const table = `üìä –°–†–ê–í–ù–ò–¢–ï–õ–¨–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê –ú–ï–¢–û–î–û–í:

üéØ –®–£–ú "–°–û–õ–¨/–ü–ï–†–ï–¶":
‚Ä¢ –ú–µ–¥–∏–∞–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
‚Ä¢ –ì–∞—É—Å—Å–æ–≤ —Ñ–∏–ª—å—Ç—Ä: ‚≠ê‚≠ê‚òÜ‚òÜ‚òÜ
‚Ä¢ –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏: ‚≠ê‚òÜ‚òÜ‚òÜ‚òÜ

üîÜ –ù–ï–†–ê–í–ù–û–ú–ï–†–ù–û–ï –û–°–í–ï–©–ï–ù–ò–ï:
‚Ä¢ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–æ—Ä–æ–≥: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê  
‚Ä¢ Otsu: ‚≠ê‚≠ê‚òÜ‚òÜ‚òÜ
‚Ä¢ –ë–∏–Ω–∞—Ä–Ω—ã–π –ø–æ—Ä–æ–≥: ‚≠ê‚òÜ‚òÜ‚òÜ‚òÜ

üå´Ô∏è –ù–ò–ó–ö–ò–ô –ö–û–ù–¢–†–ê–°–¢:
‚Ä¢ Otsu: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
‚Ä¢ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–æ—Ä–æ–≥: ‚≠ê‚≠ê‚≠ê‚òÜ‚òÜ
‚Ä¢ –ë–∏–Ω–∞—Ä–Ω—ã–π –ø–æ—Ä–æ–≥: ‚≠ê‚òÜ‚òÜ‚òÜ‚òÜ

üí° –í–´–í–û–î: –í—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è`;
                alert(table);
            }
        }

        const app = new ImageProcessor();
    </script>
</body>
</html>